<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Web Barcode Detector with OpenCV.js</title>
<style>
  #imageContainer {
    max-width: 300px;
    max-height: 300px;
    overflow: auto;
  }

  .fullscreen {
    width:100%;
    height:100%;
    position:absolute;
    left:0;
    top:0;
    background: white;
  }

  #cameraSelect {
    z-index:999;
    top:0;
    position:absolute;
  }

  #closeButton {
    z-index:999;
    position:absolute;
    right:0;
    top:0;
  }

</style>
</head>
<body>
<h2>Web Barcode Detector with OpenCV.js</h2>
<p id="status">OpenCV.js is loading...</p>
<div>
  <div>
    Barcode Formats:
    <select id="barcodeSelect" onchange="switchDetector()">
      <option>1D (EAN13, UPCA)</option>
      <option>2D (QR Code)</option>
    </select>
  </div>
  Select an image:<input type="file" id="fileInput" name="file" />
  <div>
    <button onclick="decodeFromImage()">Decode from the image</button>
    <button onclick="startLiveScan()">Live scan</button>
  </div>
  <div id="imageContainer">
    <img id="imageSrc" alt=""/>
  </div>
  <div id="resultContainer">
  </div>
  <div class="scanner" style="display:none;">
    <select id="cameraSelect" onchange="switchCamera();"></select>
    <button id="closeButton" onclick="stopLiveScan()">Close</button>
    <canvas id="hiddenCanvas" style="display: none;"></canvas>
    <video class="camera fullscreen" muted autoplay="autoplay" playsinline="playsinline" webkit-playsinline></video>
  </div>
</div>
<script type="text/javascript">
  let detector;
  let imgElement = document.getElementById('imageSrc');
  let inputElement = document.getElementById('fileInput');
  let localStream;
  let interval;
  let decoding = false;

  inputElement.addEventListener('change', (e) => {
    imgElement.src = URL.createObjectURL(e.target.files[0]);
  }, false);

  document.getElementsByClassName("camera")[0].addEventListener('loadeddata',() => {
    startDecodingLoop();
  }, false);

  function decodeFromImage(){
    let mat = cv.imread(imgElement);
    let result = detector.detectAndDecode(mat);
    mat.delete();
    if (result) {
      displayBarcodeResults([result]);
    }else{
      alert("No barcodes found.");
    }
  }

  function displayBarcodeResults(results){
    let resultContainer = document.getElementById("resultContainer");
    resultContainer.innerHTML = "";
    let list = document.createElement("ol");
    for (let index = 0; index < results.length; index++) {
      const result = results[index];
      let item = document.createElement("li");
      item.innerText = result;
      list.appendChild(item);
    }
    resultContainer.appendChild(list);
  }

  function switchDetector(){
    let selectedIndex = document.getElementById("barcodeSelect").selectedIndex;
    if (cv) {
      if (selectedIndex === 0) {
        detector = new cv.barcode_BarcodeDetector();
      }else{
        detector = new cv.QRCodeDetector();
      }
    }
  }

  function startLiveScan(){
    document.getElementsByClassName("scanner")[0].style.display = "";
    loadDevicesAndPlay();
  }

  function stopLiveScan(){
    stopDecodingLoop();
    document.getElementsByClassName("scanner")[0].style.display = "none";
    stop();
  }

  function startDecodingLoop(){
    stopDecodingLoop();
    interval = setInterval(captureAndDecode,200);
  }

  function captureAndDecode(){
    if (decoding) {
      return;
    }
    if (!cv) {
      return;
    }
    decoding = true;
    capture();
    let mat = cv.imread(document.getElementById("hiddenCanvas"));
    let result = detector.detectAndDecode(mat);
    console.log(result);
    mat.delete();
    if (result != "") {
      stopLiveScan();
      displayBarcodeResults([result]);
    }
    decoding = false;
  }

  function capture(){
    let video = document.getElementsByClassName("camera")[0];
    let canvas = document.getElementById("hiddenCanvas");
    let w = video.videoWidth;
    let h = video.videoHeight;
    canvas.width  = w;
    canvas.height = h;
    let ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, w, h);
  }

  function stopDecodingLoop(){
    clearInterval(interval);
    decoding = false;
  }
  
  function loadDevicesAndPlay(){
    var constraints = {video: true, audio: false};
    navigator.mediaDevices.getUserMedia(constraints).then(stream => {
      localStream = stream;
      var cameraselect = document.getElementById("cameraSelect");
      cameraselect.innerHTML="";
      navigator.mediaDevices.enumerateDevices().then(function(devices) {
        var count = 0;
        var cameraDevices = [];
        var defaultIndex = 0;
        for (var i=0;i<devices.length;i++){
            var device = devices[i];
            if (device.kind == 'videoinput'){
                cameraDevices.push(device);
                var label = device.label || `Camera ${count++}`;
                cameraselect.add(new Option(label,device.deviceId));
                if (label.toLowerCase().indexOf("back") != -1) { //select the back camera as the default
                  defaultIndex = cameraDevices.length - 1;
                }
            }
        }

        if (cameraDevices.length>0) {
          cameraselect.selectedIndex = defaultIndex;
          play(cameraDevices[defaultIndex].deviceId);
        }else{
          alert("No camera detected.");
        }
      });
    });
  }

  function switchCamera(){
    var cameraselect = document.getElementById("cameraSelect");
    let selectedOption = cameraselect.selectedOptions[0];
    play(selectedOption.value);
  }

  function play(deviceId) {
    stop(); // close before play
    var constraints = {};

    if (!!deviceId){
      constraints = {
        video: {deviceId: deviceId},
        audio: false
      }
    }else{
      constraints = {
        video: true,
        audio: false
      }
    }

    navigator.mediaDevices.getUserMedia(constraints).then(function(stream) {
      localStream = stream;
      var cameraVideo = document.getElementsByClassName("camera")[0];
      // Attach local stream to video element
      cameraVideo.srcObject = stream;
    }).catch(function(err) {
      console.error('getUserMediaError', err, err.stack);
      alert(err.message);
    });
  }

  function stop(){
    try{
      if (localStream){
        localStream.getTracks().forEach(track => track.stop());
      }
    } catch (e){
      alert(e.message);
    }
  }

  var Module = {
    // https://emscripten.org/docs/api_reference/module.html#Module.onRuntimeInitialized
    onRuntimeInitialized() {
      document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
      detector = new cv.barcode_BarcodeDetector();
    }
  };
</script>
<script async src="https://docs.opencv.org/4.8.0/opencv.js" type="text/javascript"></script>
</body>
</html>